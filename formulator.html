<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulator - Perfumer's Shelf</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="bg-image"></div>
    <div class="main-canvas">
        <header>
            <a href="/PerfumeWeb/index.html"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" x="0px" y="0px" class="logo-icon" viewBox="0 0 496 620" style="enable-background:new 0 0 496 496;" xml:space="preserve"><path d="M480,160h-16c-8.822,0-16,7.178-16,16v32h-1.361L425.086,93.051C423.668,85.488,417.055,80,409.361,80H400V64h16  c8.822,0,16-7.178,16-16V24c0-13.233-10.766-24-24-24h-64c-13.234,0-24,10.767-24,24v24c0,8.822,7.178,16,16,16h16v16h-9.36  c-7.694,0-14.308,5.488-15.726,13.051L317.361,144H288v-16h16c8.822,0,16-7.178,16-16V88c0-13.233-10.766-24-24-24h-64  c-13.234,0-24,10.767-24,24v24c0,8.822,7.178,16,16,16h16v16h-32c-8.822,0-16,7.178-16,16v48h-16v-64c0-8.822-7.178-16-16-16h-16  v-16h16c8.822,0,16-7.178,16-16V72c0-13.233-10.766-24-24-24H88c-13.234,0-24,10.767-24,24v24c0,8.822,7.178,16,16,16h16v16H80  c-8.822,0-16,7.178-16,16v64H48v-32c0-8.822-7.178-16-16-16H16c-8.822,0-16,7.178-16,16v304c0,8.822,7.178,16,16,16h464  c8.822,0,16-7.178,16-16V176C496,167.178,488.822,160,480,160z M32,480H16V176h16V480z M336,24c0-4.411,3.589-8,8-8h64  c4.411,0,8,3.589,8,8l0.01,24c0,0-0.003,0-0.01,0h-80V24z M368,64h16v16h-16V64z M409.361,96l21,112H336v-48  c0-3.762-1.313-7.218-3.495-9.953L342.64,96H409.361z M224,88c0-4.411,3.589-8,8-8h64c4.411,0,8,3.589,8,8l0.01,24  c0,0-0.003,0-0.01,0h-80V88z M256,128h16v16h-16V128z M208,160h112v48H208V160z M80,72c0-4.411,3.589-8,8-8h64c4.411,0,8,3.589,8,8  l0.01,24c0,0-0.003,0-0.01,0H80V72z M112,112h16v16h-16V112z M80,144h80v64H80V144z M448,224v32H48v-32H448z M368,336v-16h16v16H368  z M352,304v-32h48v32H352z M352,320v16h-1.223c-7.854,0-14.491,5.622-15.782,13.369l-4.615,27.691  C317.83,343.756,285.64,320,248,320c-32.174,0-60.365,17.359-75.713,43.2C168.029,356.477,160.53,352,152,352h-8v-8  c0-6.142-2.322-11.75-6.131-16c3.809-4.25,6.131-9.858,6.131-16c0-13.233-10.766-24-24-24s-24,10.767-24,24  c0,6.142,2.322,11.75,6.131,16C98.322,332.25,96,337.858,96,344v8h-8c-13.234,0-24,10.767-24,24v56H48V272h288v32  C336,312.822,343.178,320,352,320z M272,400h-48v-8c0-4.411,3.589-8,8-8h32c4.411,0,8,3.589,8,8V400z M264,368h-32  c-13.233,0-24,10.767-24,24v8h-31.545c3.994-35.948,34.549-64,71.545-64s67.551,28.052,71.545,64H288v-8  C288,378.767,277.233,368,264,368z M112,312c0-4.411,3.589-8,8-8s8,3.589,8,8s-3.589,8-8,8S112,316.411,112,312z M112,344  c0-4.411,3.589-8,8-8s8,3.589,8,8v8h-16V344z M80,376c0-4.411,3.589-8,8-8h64c4.411,0,8,3.589,8,8v56H80V376z M176,416h144v16H176  V416z M350.777,352h50.446l13.333,80h-77.113L350.777,352z M430.777,432l-13.772-82.631c-1.292-7.747-7.929-13.369-15.782-13.369  H400v-16c8.822,0,16-7.178,16-16v-32h32v160H430.777z M48,480v-32h400v32H48z M480,480h-16V176h16V480z"/></svg></a>
       
            <nav id="main-navigation">

                <ul class="sidebar" id="sidebar">
                    <li><a href="/PerfumeWeb/naturals.html">Naturals</a></li>
                    <li><a href="/PerfumeWeb/synthetics.html">Synthetics</a></li>
                    <li><a href="/PerfumeWeb/formulator.html">Formulator</a></li>
                    <li><a href="/PerfumeWeb/library.html">Library</a></li>
                    <li><a href="/PerfumeWeb/collections.html">Collections</a></li>
                </ul>
            

                <ul class="menu-items">
                    <li class="hideOnMobile"><a href="/PerfumeWeb/naturals.html">Naturals</a></li>
                    <li class="hideOnMobile"><a href="/PerfumeWeb/synthetics.html">Synthetics</a></li>
                    <li class="hideOnMobile"><a href="/PerfumeWeb/formulator.html">Formulator</a></li>
                    <li class="hideOnMobile"><a href="/PerfumeWeb/library.html">Library</a></li>
                    <li class="hideOnMobile"><a href="/PerfumeWeb/collections.html">Collections</a></li>

                    <li id="hamburger-menu" onclick="toggleSidebar()"><a href="#"><svg class="ham hamRotate ham4" viewBox="0 0 100 100" width="80" onclick="this.classList.toggle('active')"><path class="line top" d="m 70,33 h -40 c 0,0 -8.5,-0.149796 -8.5,8.5 0,8.649796 8.5,8.5 8.5,8.5 h 20 v -20" /><path class="line middle" d="m 70,50 h -40" /><path class="line bottom" d="m 30,67 h 40 c 0,0 8.5,0.149796 8.5,-8.5 0,-8.649796 -8.5,-8.5 -8.5,-8.5 h -20 v 20" /></svg></a></li>
                </ul>

            </nav>
            
        </header>

        <div class="overlay-container">
            <section class="materials">
                <h1>Formulator</h1>
                
                <!-- Input for formula name -->
                <div>
                    <label class="formulaName" for="formulaName">Formula Name:</label>
                    <input type="text" id="formulaName" placeholder="Enter formula name...">
                </div>

                <div>
                    <label for="material">Material:</label>
                    <input type="text" id="material" list="materials" placeholder="Type material name">
                    
                    <label for="percentage">Parts (out of 1000):</label>
                    <input type="number" id="percentage" min="0" max="1000" placeholder="0 parts">
                    <button onclick="addMaterial()">Add</button>
                </div>

                <div class="percentage-meter">
                    <span id="percentage-display">0%</span> of the formula used
                </div>
                <div class="progress-bar">
                    <div id="progress" class="progress green" style="width: 0%"></div>
                </div>

                <div>
                    <label for="desired-quantity">Desired Quantity:</label>
                    <input type="number" id="desired-quantity" min="1" placeholder="10g" onchange="updateQuantities()">
                </div>

                <div class="material-list" id="material-list"></div>

                <!-- Ingredient count and download button -->
                <p id="ingredientCount">Ingredients used: 0</p>
                <!--<button id="download-btn" onclick="downloadMaterial()" disabled>Download</button>-->
                <button id="save-to-library-btn" onclick="savetolibrary()" disabled>Save to library</button>
            </section>
        </div>
    </div>

    <script>
let materials = [];
let totalParts = 0;

function addMaterial() {
    const material = document.getElementById('material').value;
    const parts = parseFloat(document.getElementById('percentage').value);
    const desiredQuantity = parseFloat(document.getElementById('desired-quantity').value || 10); // Default to 10 grams

    if (material && parts && parts > 0) {
        if (totalParts + parts <= 1000) { 
            totalParts += parts;
            const grams = ((desiredQuantity * parts) / 1000).toFixed(3); 
            const percentage = ((parts / 1000) * 100).toFixed(1); 
            materials.push({ material, parts, grams, percentage });
            updateUI();
            toggleDownloadButton();
        } else {
            alert("Total parts cannot exceed 1000");
        }
    }
}

function updateUI() {
    const progressElement = document.getElementById('progress');
    const materialListElement = document.getElementById('material-list');
    const percentageDisplay = document.getElementById('percentage-display');
    const ingredientCount = document.getElementById('ingredientCount');

    const totalPercentage = ((totalParts / 1000) * 100).toFixed(1);
    progressElement.style.width = `${totalPercentage}%`;

    if (totalParts < 1000) {
        progressElement.className = 'progress green';
    } else if (totalParts === 1000) {
        progressElement.className = 'progress max-green';
    } else {
        progressElement.className = 'progress red';
    }

    percentageDisplay.textContent = `${totalPercentage}% (${totalParts} parts)`;

    materialListElement.innerHTML = '';
    materials.forEach(material => {
        const div = document.createElement('div');
        div.textContent = `${material.material}: ${material.parts} parts (${material.grams}g, ${material.percentage}%)`;
        
        const editButton = document.createElement('button');
        editButton.textContent = "Edit";
        editButton.onclick = () => editMaterial(materials.indexOf(material));
        div.appendChild(editButton);

        const removeButton = document.createElement('button');
        removeButton.textContent = "Remove";
        removeButton.onclick = () => removeMaterial(materials.indexOf(material));
        div.appendChild(removeButton);

        materialListElement.appendChild(div);
    });

    ingredientCount.textContent = `Ingredients used: ${materials.length}`;
}

function updateQuantities() {
    const desiredQuantity = parseFloat(document.getElementById('desired-quantity').value || 10);
    materials.forEach(material => {
        material.grams = ((desiredQuantity * material.parts) / 1000).toFixed(3);
    });
    updateUI();
}

function toggleDownloadButton() {
    //const downloadBtn = document.getElementById('download-btn');
    //downloadBtn.disabled = materials.length === 0;
    const Btn = document.getElementById('save-to-library-btn');
    Btn.disabled = materials.length === 0;
}

function downloadMaterial() {
    if (materials.length === 0) {
        alert("No materials in the formula to download.");
        return;
    }

    const formulaName = document.getElementById('formulaName').value || "Unnamed Formula";
    const ingredientCount = materials.length;
    const desiredQuantity = parseFloat(document.getElementById('desired-quantity').value || 10);

    // Sort materials by parts in descending order
    const sortedMaterials = [...materials].sort((a, b) => b.parts - a.parts);

    // Capture the current date in YYYY-MM-DD format
    const currentDate = new Date().toISOString().split('T')[0];

    // Prepare JSON structure with the desired quantity and date
    const formulaData = {
        name: formulaName,
        ingredient_count: ingredientCount,
        desired_quantity: `${desiredQuantity}g`, // Adding desired quantity to JSON
        date: currentDate, // Adding only the date to JSON
        materials: sortedMaterials // Use sorted materials
    };

    const data = JSON.stringify(formulaData, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${formulaName.replace(/ /g, '_')}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}


function savetolibrary() {
    if (materials.length === 0) {
        alert("No materials in the formula to download.");
        return;
    }

    const formulaName = document.getElementById('formulaName').value || "Unnamed Formula";
    const ingredientCount = materials.length;
    const desiredQuantity = parseFloat(document.getElementById('desired-quantity').value || 10);

    // Sort materials by parts in descending order
    const sortedMaterials = [...materials].sort((a, b) => b.parts - a.parts);

    // Capture the current date in YYYY-MM-DD format
    const currentDate = new Date().toISOString().split('T')[0];

    // Prepare JSON structure with the desired quantity and date
    const formulaData = {
        name: formulaName,
        ingredient_count: ingredientCount,
        desired_quantity: `${desiredQuantity}g`, // Adding desired quantity to JSON
        date: currentDate, // Adding only the date to JSON
        materials: sortedMaterials // Use sorted materials
    };

    const data = JSON.stringify(formulaData);

    fetch('http://127.0.0.1:5000/add_to_library', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: data
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(error => {
                throw new Error(error.message || 'Failed to add formula');
            });
        }
        return response.json();
    })
    .then(result => {
        //alert(result.message || 'Formula added successfully!');
    })
    .catch(error => {
        console.error('Request failed', error);
        alert(`An error occurred while adding the formula to the library: ${error.message}`);
    });
}


function editMaterial(index) {
    const newParts = prompt("Enter new parts:", materials[index].parts);
    if (newParts !== null && !isNaN(newParts) && newParts > 0) {
        const oldParts = materials[index].parts;
        const desiredQuantity = parseFloat(document.getElementById('desired-quantity').value || 10);

        if (totalParts - oldParts + parseFloat(newParts) <= 1000) {
            totalParts = totalParts - oldParts + parseFloat(newParts);
            materials[index].parts = parseFloat(newParts);
            materials[index].grams = ((desiredQuantity * newParts) / 1000).toFixed(3);
            materials[index].percentage = ((newParts / 1000) * 100).toFixed(1);
            updateUI();
            toggleDownloadButton();
        } else {
            alert("Total parts cannot exceed 1000");
        }
    }
}

function removeMaterial(index) {
    totalParts -= materials[index].parts;
    materials.splice(index, 1);
    updateUI();
    toggleDownloadButton();
}

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    sidebar.classList.toggle('active');
    const isActive = sidebar.classList.contains('active');

    // Toggle sidebar state
    document.body.style.overflow = isActive ? 'hidden' : 'auto'; // Prevent scrolling when sidebar is active
}

    </script>
</body>
</html>
